# ‚úÖ Approval Workflows: Onay S√ºre√ßleri Sistemi

Bu dok√ºmantasyon, Hizmet ERP sistemi i√ßin geli≈ütirilen onay s√ºre√ßleri y√∂netim sistemi hakkƒ±nda detaylƒ± bilgi i√ßermektedir.

## üìã ƒ∞√ßindekiler

1. [Genel Bakƒ±≈ü](#genel-bakƒ±≈ü)
2. [√ñzellikler](#√∂zellikler)
3. [Kurulum](#kurulum)
4. [Kullanƒ±m](#kullanƒ±m)
5. [Teknik Detaylar](#teknik-detaylar)
6. [API Referansƒ±](#api-referansƒ±)
7. [√ñrnekler](#√∂rnekler)

---

## üéØ Genel Bakƒ±≈ü

Approval Workflows sistemi, organizasyonlarda onay gerektiren s√ºre√ßleri dijitalle≈ütirmek ve otomatikle≈ütirmek i√ßin tasarlanmƒ±≈ü kapsamlƒ± bir √ß√∂z√ºmd√ºr. Masraf onaylarƒ±, satƒ±n alma talepleri, izin talepleri ve diƒüer onay s√ºre√ßlerini y√∂netmek i√ßin kullanƒ±lƒ±r.

### üé® Aray√ºz √ñzellikleri

- **G√∂rsel S√ºre√ß Y√∂netimi**: Onay s√ºre√ßlerini g√∂rsel olarak tasarlama
- **√áoklu Onay Tipleri**: Sƒ±ralƒ±, paralel ve ko≈üullu onay s√ºre√ßleri
- **Ger√ßek Zamanlƒ± Takip**: Onay durumlarƒ±nƒ± anlƒ±k takip etme
- **Bildirim Sistemi**: Otomatik e-posta ve sistem bildirimleri
- **Vekalet Sistemi**: Onay yetkisini ba≈ükasƒ±na devretme
- **Timeout Y√∂netimi**: Otomatik onay/red s√ºreleri

---

## üöÄ √ñzellikler

### üìä Onay S√ºre√ß Tipleri

#### **1. Sƒ±ralƒ± Onay (Sequential)**
- **Tanƒ±m**: Onaylarƒ±n belirli bir sƒ±rayla ger√ßekle≈ümesi
- **Kullanƒ±m**: Masraf onaylarƒ±, satƒ±n alma talepleri
- **√ñzellikler**: 
  - Her adƒ±m bir √∂nceki adƒ±mƒ±n onayƒ±ndan sonra ba≈ülar
  - Tek onaylayƒ±cƒ± reddederse s√ºre√ß durur
  - T√ºm adƒ±mlar tamamlanmalƒ±

#### **2. Paralel Onay (Parallel)**
- **Tanƒ±m**: Birden fazla onaylayƒ±cƒ±nƒ±n aynƒ± anda onay vermesi
- **Kullanƒ±m**: Acil durumlar, b√ºy√ºk b√ºt√ßeli projeler
- **√ñzellikler**:
  - T√ºm onaylayƒ±cƒ±lar aynƒ± anda bilgilendirilir
  - Belirlenen sayƒ±da onay yeterli olabilir
  - Hƒ±zlƒ± karar verme s√ºreci

#### **3. Ko≈üullu Onay (Conditional)**
- **Tanƒ±m**: Belirli ko≈üullara g√∂re farklƒ± onay yollarƒ±
- **Kullanƒ±m**: Tutara g√∂re farklƒ± onay seviyeleri
- **√ñzellikler**:
  - Dinamik onay yollarƒ±
  - Ko≈üul bazlƒ± atlama
  - Esnek s√ºre√ß tasarƒ±mƒ±

### üîß Geli≈ümi≈ü √ñzellikler

#### **Vekalet Sistemi**
- **Yetki Devretme**: Onay yetkisini ba≈ükasƒ±na devretme
- **Vekalet Seviyeleri**: Maksimum vekalet seviyesi kontrol√º
- **Otomatik Vekalet**: Belirli durumlarda otomatik vekalet
- **Vekalet Ge√ßmi≈üi**: Vekalet verilen ki≈üilerin takibi

#### **Timeout Y√∂netimi**
- **Adƒ±m Timeout'u**: Her adƒ±m i√ßin ayrƒ± timeout s√ºresi
- **Otomatik Onay**: Timeout sonrasƒ± otomatik onay
- **Otomatik Red**: Timeout sonrasƒ± otomatik red
- **Hatƒ±rlatma Bildirimleri**: Timeout yakla≈üƒ±rken uyarƒ±lar

#### **Bildirim Sistemi**
- **E-posta Bildirimleri**: Otomatik e-posta g√∂nderimi
- **Sistem Bildirimleri**: Uygulama i√ßi bildirimler
- **SMS Bildirimleri**: Acil durumlar i√ßin SMS
- **Slack/Teams Entegrasyonu**: Kurumsal mesajla≈üma

---

## üõ†Ô∏è Kurulum

### 1. Veritabanƒ± Migration'ƒ±

#### Y√∂ntem 1: Node.js Script
```bash
# Environment variables'larƒ± ayarlayƒ±n
export VITE_SUPABASE_URL="your-supabase-url"
export SUPABASE_SERVICE_ROLE_KEY="your-service-role-key"

# Migration'ƒ± √ßalƒ±≈ütƒ±rƒ±n
npm run approval-migration
```

#### Y√∂ntem 2: Supabase Dashboard
1. Supabase Dashboard'a giri≈ü yapƒ±n
2. SQL Editor'√º a√ßƒ±n
3. `supabase/migrations/20241201_approval_workflows.sql` dosyasƒ±nƒ±n i√ßeriƒüini kopyalayƒ±n
4. SQL Editor'de √ßalƒ±≈ütƒ±rƒ±n

### 2. Uygulamayƒ± Ba≈ülatma
```bash
npm run dev
```

### 3. Eri≈üim
- Sidebar'dan "Onay S√ºre√ßleri" se√ßin
- Veya `/approval-workflows` URL'ine gidin

---

## üìñ Kullanƒ±m

### üé® Onay S√ºreci Olu≈üturma

#### 1. Yeni S√ºre√ß
```typescript
// Yeni onay s√ºreci olu≈ütur
const newWorkflow: ApprovalWorkflow = {
  name: 'Masraf Onay S√ºreci',
  description: 'Masraf raporlarƒ± i√ßin onay s√ºreci',
  workflow_type: 'sequential',
  status: 'active',
  workflow_config: {},
  trigger_conditions: {
    request_type: 'expense',
    amount_threshold: 1000
  },
  auto_approve_timeout: 48,
  require_all_approvers: false,
  allow_delegate: true,
  max_delegation_level: 1
};
```

#### 2. Onay Adƒ±mlarƒ± Ekleme
```typescript
// Onay adƒ±mƒ± ekle
const approvalStep: ApprovalStep = {
  step_order: 1,
  step_name: 'Y√∂netici Onayƒ±',
  step_type: 'approval',
  approver_type: 'role',
  approver_config: {
    role: 'manager',
    department: 'IT'
  },
  timeout_hours: 24,
  is_required: true,
  can_skip: false
};
```

#### 3. Onay Talebi Olu≈üturma
```typescript
// Onay talebi olu≈ütur
const approvalRequest: ApprovalRequest = {
  approval_workflow_id: 'workflow-id',
  request_type: 'expense',
  request_data: {
    amount: 1500,
    description: 'Yazƒ±lƒ±m lisansƒ±',
    category: 'software'
  },
  requester_id: 'user-id',
  priority: 'normal',
  total_steps: 2,
  completed_steps: 0
};
```

### üîÑ Onay S√ºreci Y√∂netimi

#### 1. Onay Verme
```typescript
// Onay kararƒ± ver
const approveRequest = async (requestId: string, stepId: string, decision: 'approved' | 'rejected', comments?: string) => {
  const { data, error } = await supabase
    .from('approval_step_status')
    .update({
      status: decision,
      decision: comments,
      decision_date: new Date().toISOString()
    })
    .eq('approval_request_id', requestId)
    .eq('step_id', stepId);
};
```

#### 2. Vekalet Verme
```typescript
// Vekalet ver
const delegateApproval = async (requestId: string, stepId: string, delegateTo: string, reason: string) => {
  const { data, error } = await supabase
    .from('approval_step_status')
    .update({
      status: 'delegated',
      delegated_to: delegateTo,
      delegation_reason: reason,
      decision_date: new Date().toISOString()
    })
    .eq('approval_request_id', requestId)
    .eq('step_id', stepId);
};
```

#### 3. Timeout Kontrol√º
```typescript
// Timeout kontrol√º
const checkTimeouts = async () => {
  const { data, error } = await supabase
    .from('approval_step_status')
    .select('*')
    .eq('status', 'pending')
    .lt('created_at', new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString());
  
  // Timeout olan adƒ±mlarƒ± i≈üle
  for (const step of data || []) {
    await handleTimeout(step);
  }
};
```

---

## üóÑÔ∏è Teknik Detaylar

### Veritabanƒ± Yapƒ±sƒ±

#### **approval_workflows Tablosu**
```sql
CREATE TABLE approval_workflows (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  name text NOT NULL,
  description text,
  workflow_type text NOT NULL DEFAULT 'sequential',
  status text DEFAULT 'active',
  version integer DEFAULT 1,
  workflow_config jsonb NOT NULL DEFAULT '{}',
  trigger_conditions jsonb DEFAULT '{}',
  auto_approve_timeout integer DEFAULT 0,
  require_all_approvers boolean DEFAULT false,
  allow_delegate boolean DEFAULT true,
  max_delegation_level integer DEFAULT 1,
  created_by uuid,
  created_at timestamptz DEFAULT now(),
  updated_at timestamptz DEFAULT now()
);
```

#### **approval_requests Tablosu**
```sql
CREATE TABLE approval_requests (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  approval_workflow_id uuid REFERENCES approval_workflows(id),
  request_type text NOT NULL,
  request_data jsonb NOT NULL DEFAULT '{}',
  requester_id uuid NOT NULL,
  current_step_id uuid REFERENCES approval_steps(id),
  status text DEFAULT 'pending',
  priority text DEFAULT 'normal',
  due_date timestamptz,
  started_at timestamptz DEFAULT now(),
  completed_at timestamptz,
  total_steps integer DEFAULT 0,
  completed_steps integer DEFAULT 0,
  created_at timestamptz DEFAULT now(),
  updated_at timestamptz DEFAULT now()
);
```

### Bile≈üen Yapƒ±sƒ±

#### **Ana Bile≈üenler**
- `ApprovalWorkflows`: Ana bile≈üen
- `WorkflowDetails`: S√ºre√ß detaylarƒ±
- `RequestDetails`: Talep detaylarƒ±
- `ApprovalStepEditor`: Adƒ±m d√ºzenleyici
- `ApprovalDashboard`: Onay paneli

#### **Hook'lar**
- `useApprovalWorkflows`: S√ºre√ß y√∂netimi
- `useApprovalRequests`: Talep y√∂netimi
- `useApprovalNotifications`: Bildirim y√∂netimi

---

## üîå API Referansƒ±

### Onay S√ºre√ßleri CRUD ƒ∞≈ülemleri

#### **S√ºre√ß Olu≈üturma**
```typescript
const createApprovalWorkflow = async (workflow: ApprovalWorkflow) => {
  const { data, error } = await supabase
    .from('approval_workflows')
    .insert([workflow]);
  return { data, error };
};
```

#### **S√ºre√ß G√ºncelleme**
```typescript
const updateApprovalWorkflow = async (id: string, updates: Partial<ApprovalWorkflow>) => {
  const { data, error } = await supabase
    .from('approval_workflows')
    .update(updates)
    .eq('id', id);
  return { data, error };
};
```

#### **S√ºre√ß Silme**
```typescript
const deleteApprovalWorkflow = async (id: string) => {
  const { error } = await supabase
    .from('approval_workflows')
    .delete()
    .eq('id', id);
  return { error };
};
```

### Onay Talepleri Y√∂netimi

#### **Talep Olu≈üturma**
```typescript
const createApprovalRequest = async (request: ApprovalRequest) => {
  const { data, error } = await supabase
    .from('approval_requests')
    .insert([request]);
  return { data, error };
};
```

#### **Talep Durumu Kontrol√º**
```typescript
const getApprovalRequestStatus = async (requestId: string) => {
  const { data, error } = await supabase
    .from('approval_requests')
    .select('*')
    .eq('id', requestId)
    .single();
  return { data, error };
};
```

#### **Onay Kararƒ± Verme**
```typescript
const submitApprovalDecision = async (stepStatusId: string, decision: string, comments?: string) => {
  const { data, error } = await supabase
    .from('approval_step_status')
    .update({
      status: decision,
      decision: comments,
      decision_date: new Date().toISOString()
    })
    .eq('id', stepStatusId);
  return { data, error };
};
```

---

## üìù √ñrnekler

### √ñrnek 1: Masraf Onay S√ºreci

```json
{
  "name": "Masraf Onay S√ºreci",
  "description": "Masraf raporlarƒ± i√ßin standart onay s√ºreci",
  "workflow_type": "sequential",
  "workflow_config": {
    "auto_approve_timeout": 48,
    "require_all_approvers": false,
    "allow_delegate": true
  },
  "trigger_conditions": {
    "request_type": "expense",
    "amount_threshold": 1000
  },
  "steps": [
    {
      "step_order": 1,
      "step_name": "Y√∂netici Onayƒ±",
      "approver_type": "role",
      "approver_config": {
        "role": "manager",
        "department": "dynamic"
      },
      "timeout_hours": 24
    },
    {
      "step_order": 2,
      "step_name": "Finans Onayƒ±",
      "approver_type": "role",
      "approver_config": {
        "role": "finance_manager"
      },
      "timeout_hours": 24
    }
  ]
}
```

### √ñrnek 2: Satƒ±n Alma Onay S√ºreci

```json
{
  "name": "Satƒ±n Alma Onay S√ºreci",
  "description": "Satƒ±n alma talepleri i√ßin onay s√ºreci",
  "workflow_type": "conditional",
  "workflow_config": {
    "auto_approve_timeout": 72,
    "require_all_approvers": true,
    "allow_delegate": false
  },
  "trigger_conditions": {
    "request_type": "purchase",
    "amount_threshold": 5000
  },
  "steps": [
    {
      "step_order": 1,
      "step_name": "Departman Onayƒ±",
      "approver_type": "role",
      "approver_config": {
        "role": "department_head"
      },
      "timeout_hours": 48
    },
    {
      "step_order": 2,
      "step_name": "Satƒ±n Alma Onayƒ±",
      "approver_type": "role",
      "approver_config": {
        "role": "procurement_manager"
      },
      "timeout_hours": 48,
      "conditions": {
        "amount_greater_than": 10000
      }
    },
    {
      "step_order": 3,
      "step_name": "Genel M√ºd√ºr Onayƒ±",
      "approver_type": "role",
      "approver_config": {
        "role": "general_manager"
      },
      "timeout_hours": 72,
      "conditions": {
        "amount_greater_than": 50000
      }
    }
  ]
}
```

---

## üîß Geli≈ütirme

### Yeni Onay Tipi Ekleme

#### 1. Onay Tipi Tanƒ±mlama
```typescript
// Yeni onay tipi ekle
const newApprovalType = {
  name: 'Proje Onayƒ±',
  type: 'project_approval',
  description: 'Proje ba≈ülatma onayƒ±',
  config_schema: {
    properties: {
      project_budget: { type: 'number' },
      project_duration: { type: 'number' }
    }
  }
};
```

#### 2. Bile≈üen Olu≈üturma
```typescript
// ProjectApprovalComponent.tsx
const ProjectApprovalComponent: React.FC<ProjectApprovalProps> = ({ request, onApprove, onReject }) => {
  return (
    <div className="project-approval">
      <div className="approval-header">
        <h3>Proje Onayƒ±</h3>
        <div className="project-details">
          <span>B√ºt√ße: {request.data.project_budget} TL</span>
          <span>S√ºre: {request.data.project_duration} ay</span>
        </div>
      </div>
      <div className="approval-actions">
        <button onClick={() => onApprove()}>Onayla</button>
        <button onClick={() => onReject()}>Reddet</button>
      </div>
    </div>
  );
};
```

#### 3. ƒ∞≈üleyici Ekleme
```typescript
// Approval handler'a ekle
const handleProjectApproval = async (requestId: string, decision: string) => {
  // Proje onayƒ± √∂zel mantƒ±ƒüƒ±
  if (decision === 'approved') {
    await createProject(requestId);
    await notifyProjectTeam(requestId);
  }
};
```

---

## üêõ Sorun Giderme

### Yaygƒ±n Sorunlar

#### 1. Migration Hatasƒ±
```bash
# Hata: Table already exists
# √á√∂z√ºm: Migration'ƒ± tekrar √ßalƒ±≈ütƒ±rƒ±n
npm run approval-migration
```

#### 2. Onay Adƒ±mƒ± Hatasƒ±
```typescript
# Hata: Step validation failed
# √á√∂z√ºm: Adƒ±m konfig√ºrasyonunu kontrol edin
const validateStep = (step: ApprovalStep) => {
  if (!step.approver_config || !step.step_name) {
    throw new Error('Adƒ±m konfig√ºrasyonu eksik');
  }
};
```

#### 3. Timeout Hatasƒ±
```typescript
# Hata: Timeout processing failed
# √á√∂z√ºm: Timeout i≈üleyicisini kontrol edin
const processTimeout = async (stepStatus: ApprovalStepStatus) => {
  try {
    await updateStepStatus(stepStatus.id, 'expired');
    await sendTimeoutNotification(stepStatus.approver_id);
  } catch (error) {
    console.error('Timeout i≈üleme hatasƒ±:', error);
  }
};
```

---

## üìû Destek

### Yardƒ±m Alma
- **GitHub Issues**: Proje repository'sinde issue a√ßƒ±n
- **Dok√ºmantasyon**: Bu README dosyasƒ±nƒ± g√ºncelleyin
- **Code Review**: Pull request ile katkƒ±da bulunun

### Katkƒ±da Bulunma
1. Fork yapƒ±n
2. Feature branch olu≈üturun
3. Deƒüi≈üikliklerinizi commit edin
4. Pull request g√∂nderin

---

## üéâ Sonu√ß

Approval Workflows sistemi, organizasyonlarda onay s√ºre√ßlerini dijitalle≈ütirerek verimliliƒüi artƒ±rƒ±r ve s√ºre√ß takibini kolayla≈ütƒ±rƒ±r. Esnek yapƒ±sƒ± sayesinde farklƒ± i≈ü s√ºre√ßlerine uyarlanabilir.

**üéØ Ana Faydalar:**
- ‚ö° Hƒ±zlƒ± onay s√ºre√ßleri
- üîÑ Otomatik s√ºre√ß y√∂netimi
- üìä G√∂rsel s√ºre√ß takibi
- üé® Kullanƒ±cƒ± dostu aray√ºz
- üîß Esnek √∂zelle≈ütirme
- üìà Performans artƒ±≈üƒ±
- üîî Otomatik bildirimler
- ‚è∞ Timeout y√∂netimi
